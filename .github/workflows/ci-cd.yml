name: CI/CD Pipeline - Fullstack Vercel Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
      - name: Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install
          fi
      - run: pnpm test || true

  build-frontend:
    name: Build Frontend
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
      - name: Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install
          fi
      - name: Build frontend
        run: pnpm --filter frontend exec vite build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

  deploy-frontend-vercel:
    name: Deploy Frontend to Vercel
    needs: build-frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
      - name: Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install
          fi
      - name: Verify and Create Vercel Frontend Project
        run: |
          npm install -g vercel@latest
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export VERCEL_USER_ID="${{ secrets.VERCEL_USER_ID }}"
          export VERCEL_ORG_ID="${{ secrets.VERCEL_ORG_ID }}"
          export VERCEL_FRONTEND_PROJECT_ID="${{ secrets.VERCEL_FRONTEND_PROJECT_ID }}"

          if [ -n "$VERCEL_ORG_ID" ]; then
            SCOPE="$VERCEL_ORG_ID"
            SCOPE_TYPE="Team"
          elif [ -n "$VERCEL_USER_ID" ]; then
            SCOPE="$VERCEL_USER_ID"
            SCOPE_TYPE="User"
          else
            echo "ERROR: Neither VERCEL_USER_ID nor VERCEL_ORG_ID is set!"
            exit 1
          fi

          if [ -z "$VERCEL_FRONTEND_PROJECT_ID" ] || [ "$VERCEL_FRONTEND_PROJECT_ID" = "dummy" ] || [ "$VERCEL_FRONTEND_PROJECT_ID" = "placeholder" ]; then
            PROJECT_EXISTS="no"
          else
            set +e
            PROJECT_INFO=$(vercel projects inspect "$VERCEL_FRONTEND_PROJECT_ID" --token "$VERCEL_TOKEN" --scope "$SCOPE" 2>&1)
            PROJECT_EXIT_CODE=$?
            set -e
            PROJECT_ERROR=$(echo "$PROJECT_INFO" | grep -i "error\|not found\|404\|unauthorized\|Project not found" || true)
            if [ $PROJECT_EXIT_CODE -ne 0 ] || [ -n "$PROJECT_ERROR" ]; then
              PROJECT_EXISTS="no"
            else
              PROJECT_EXISTS="yes"
              echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
            fi
          fi

          if [ "$PROJECT_EXISTS" = "no" ]; then
            PROJECT_NAME="${{ github.event.repository.name }}-frontend"
            LIST_URL="https://api.vercel.com/v9/projects"
            if [ "$SCOPE_TYPE" = "Team" ]; then
              LIST_URL="$LIST_URL?teamId=$SCOPE"
            fi
            LIST_RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" "$LIST_URL")
            
            if command -v jq &> /dev/null; then
              EXISTING_PROJECT_ID=$(echo "$LIST_RESPONSE" | jq -r ".projects[] | select(.name == \"$PROJECT_NAME\") | .id" | head -1)
            else
              EXISTING_PROJECT_ID=$(echo "$LIST_RESPONSE" | grep -A 20 "\"name\":\"$PROJECT_NAME\"" | grep -o "\"id\":\"[^\"]*" | head -1 | cut -d'"' -f4)
            fi
            
            if [ -z "$EXISTING_PROJECT_ID" ] || [ "$EXISTING_PROJECT_ID" = "null" ]; then
              EXISTING_PROJECT_ID=$(echo "$LIST_RESPONSE" | grep -o "\"name\":\"$PROJECT_NAME\"" -A 5 | grep -o "\"id\":\"[^\"]*" | head -1 | cut -d'"' -f4)
            fi
            
            if [ -n "$EXISTING_PROJECT_ID" ]; then
              echo "VERCEL_FRONTEND_PROJECT_ID=$EXISTING_PROJECT_ID" >> $GITHUB_ENV
              echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
              PROJECT_EXISTS="yes"
            else
              CREATE_URL="https://api.vercel.com/v9/projects"
              if [ "$SCOPE_TYPE" = "Team" ]; then
                CREATE_URL="$CREATE_URL?teamId=$SCOPE"
              fi
              CREATE_RESPONSE=$(curl -s -X POST "$CREATE_URL" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{
                  \"name\": \"$PROJECT_NAME\",
                  \"framework\": \"vite\",
                  \"gitRepository\": {
                    \"type\": \"github\",
                    \"repo\": \"${{ github.repository }}\",
                    \"productionBranch\": \"main\"
                  }
                }")
              
              if echo "$CREATE_RESPONSE" | grep -q "\"id\""; then
                NEW_PROJECT_ID=$(echo "$CREATE_RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
                echo "VERCEL_FRONTEND_PROJECT_ID=$NEW_PROJECT_ID" >> $GITHUB_ENV
                echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
                PROJECT_EXISTS="yes"
              elif echo "$CREATE_RESPONSE" | grep -q "already exists\|conflict"; then
                LIST_RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" "$LIST_URL")
                if command -v jq &> /dev/null; then
                  EXISTING_PROJECT_ID=$(echo "$LIST_RESPONSE" | jq -r ".projects[] | select(.name == \"$PROJECT_NAME\") | .id" | head -1)
                else
                  EXISTING_PROJECT_ID=$(echo "$LIST_RESPONSE" | grep -A 20 "\"name\":\"$PROJECT_NAME\"" | grep -o "\"id\":\"[^\"]*" | head -1 | cut -d'"' -f4)
                fi
                if [ -z "$EXISTING_PROJECT_ID" ] || [ "$EXISTING_PROJECT_ID" = "null" ]; then
                  EXISTING_PROJECT_ID=$(echo "$LIST_RESPONSE" | grep -o "\"name\":\"$PROJECT_NAME\"" -A 5 | grep -o "\"id\":\"[^\"]*" | head -1 | cut -d'"' -f4)
                fi
                if [ -n "$EXISTING_PROJECT_ID" ]; then
                  echo "VERCEL_FRONTEND_PROJECT_ID=$EXISTING_PROJECT_ID" >> $GITHUB_ENV
                  echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
                  PROJECT_EXISTS="yes"
                else
                  echo "Failed to find existing project after conflict"
                  exit 1
                fi
              else
                echo "Failed to create frontend project"
                exit 1
              fi
            fi
          else
            UPDATE_URL="https://api.vercel.com/v9/projects/$VERCEL_FRONTEND_PROJECT_ID"
            if [ "$SCOPE_TYPE" = "Team" ]; then
              UPDATE_URL="$UPDATE_URL?teamId=$SCOPE"
            fi
            CURRENT_PROJECT=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" "$UPDATE_URL")
            CURRENT_ROOT_DIR=$(echo "$CURRENT_PROJECT" | grep -o '"rootDirectory":"[^"]*' | cut -d'"' -f4 || echo "")
            if [ -n "$CURRENT_ROOT_DIR" ] && [ "$CURRENT_ROOT_DIR" != "" ]; then
              UPDATE_RESPONSE=$(curl -s -X PATCH "$UPDATE_URL" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"rootDirectory\": null}")
            fi
          fi

          echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
      - name: Deploy Frontend to Vercel
        id: vercel-deploy
        uses: amondnet/vercel-action@v25
        continue-on-error: false
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID || secrets.VERCEL_ORG_ID || secrets.VERCEL_USER_ID }}
          vercel-project-id: ${{ env.VERCEL_FRONTEND_PROJECT_ID || secrets.VERCEL_FRONTEND_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: .
          scope: ${{ env.VERCEL_ORG_ID || secrets.VERCEL_ORG_ID || secrets.VERCEL_USER_ID }}
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

  deploy-backend-vercel:
    name: Deploy Backend to Vercel
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
      - name: Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install
          fi
      - name: Verify and Create Vercel Backend Project
        run: |
          npm install -g vercel@latest
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export VERCEL_USER_ID="${{ secrets.VERCEL_USER_ID }}"
          export VERCEL_ORG_ID="${{ secrets.VERCEL_ORG_ID }}"
          export VERCEL_BACKEND_PROJECT_ID="${{ secrets.VERCEL_BACKEND_PROJECT_ID }}"

          if [ -n "$VERCEL_ORG_ID" ]; then
            SCOPE="$VERCEL_ORG_ID"
            SCOPE_TYPE="Team"
          elif [ -n "$VERCEL_USER_ID" ]; then
            SCOPE="$VERCEL_USER_ID"
            SCOPE_TYPE="User"
          else
            echo "ERROR: Neither VERCEL_USER_ID nor VERCEL_ORG_ID is set!"
            exit 1
          fi

          if [ -z "$VERCEL_BACKEND_PROJECT_ID" ] || [ "$VERCEL_BACKEND_PROJECT_ID" = "dummy" ] || [ "$VERCEL_BACKEND_PROJECT_ID" = "placeholder" ]; then
            PROJECT_EXISTS="no"
          else
            set +e
            PROJECT_INFO=$(vercel projects inspect "$VERCEL_BACKEND_PROJECT_ID" --token "$VERCEL_TOKEN" --scope "$SCOPE" 2>&1)
            PROJECT_EXIT_CODE=$?
            set -e
            PROJECT_ERROR=$(echo "$PROJECT_INFO" | grep -i "error\|not found\|404\|unauthorized\|Project not found" || true)
            if [ $PROJECT_EXIT_CODE -ne 0 ] || [ -n "$PROJECT_ERROR" ]; then
              if [ "$SCOPE_TYPE" = "Team" ] && [ -n "$VERCEL_USER_ID" ]; then
                set +e
                PROJECT_INFO_USER=$(vercel projects inspect "$VERCEL_BACKEND_PROJECT_ID" --token "$VERCEL_TOKEN" --scope "$VERCEL_USER_ID" 2>&1)
                USER_EXIT_CODE=$?
                set -e
                if [ $USER_EXIT_CODE -eq 0 ] && ! echo "$PROJECT_INFO_USER" | grep -q "Project not found\|not found\|404\|Error"; then
                  SCOPE="$VERCEL_USER_ID"
                  SCOPE_TYPE="User"
                  PROJECT_EXISTS="yes"
                  echo "VERCEL_ORG_ID=$VERCEL_USER_ID" >> $GITHUB_ENV
                else
                  PROJECT_EXISTS="no"
                fi
              elif [ "$SCOPE_TYPE" = "User" ] && [ -n "$VERCEL_ORG_ID" ]; then
                set +e
                PROJECT_INFO_TEAM=$(vercel projects inspect "$VERCEL_BACKEND_PROJECT_ID" --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" 2>&1)
                TEAM_EXIT_CODE=$?
                set -e
                if [ $TEAM_EXIT_CODE -eq 0 ] && ! echo "$PROJECT_INFO_TEAM" | grep -q "Project not found\|not found\|404\|Error"; then
                  SCOPE="$VERCEL_ORG_ID"
                  SCOPE_TYPE="Team"
                  PROJECT_EXISTS="yes"
                  echo "VERCEL_ORG_ID=$VERCEL_ORG_ID" >> $GITHUB_ENV
                else
                  PROJECT_EXISTS="no"
                fi
              else
                PROJECT_EXISTS="no"
              fi
            else
              PROJECT_EXISTS="yes"
              echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
            fi
          fi

          if [ "$PROJECT_EXISTS" = "no" ]; then
            PROJECT_NAME="${{ github.event.repository.name }}-backend"
            CREATE_URL="https://api.vercel.com/v9/projects"
            if [ "$SCOPE_TYPE" = "Team" ]; then
              CREATE_URL="$CREATE_URL?teamId=$SCOPE"
            fi
            CREATE_RESPONSE=$(curl -s -X POST "$CREATE_URL" \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"$PROJECT_NAME\",
                \"framework\": null,
                \"gitRepository\": {
                  \"type\": \"github\",
                  \"repo\": \"${{ github.repository }}\",
                  \"productionBranch\": \"main\"
                }
              }")
            
            if echo "$CREATE_RESPONSE" | grep -q "\"id\""; then
              NEW_PROJECT_ID=$(echo "$CREATE_RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
              echo "VERCEL_BACKEND_PROJECT_ID=$NEW_PROJECT_ID" >> $GITHUB_ENV
            else
              echo "Failed to create backend project"
              exit 1
            fi
          else
            UPDATE_URL="https://api.vercel.com/v9/projects/$VERCEL_BACKEND_PROJECT_ID"
            if [ "$SCOPE_TYPE" = "Team" ]; then
              UPDATE_URL="$UPDATE_URL?teamId=$SCOPE"
            fi
            CURRENT_PROJECT=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" "$UPDATE_URL")
            CURRENT_ROOT_DIR=$(echo "$CURRENT_PROJECT" | grep -o '"rootDirectory":"[^"]*' | cut -d'"' -f4 || echo "")
            if [ -n "$CURRENT_ROOT_DIR" ]; then
              UPDATE_RESPONSE=$(curl -s -X PATCH "$UPDATE_URL" \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"rootDirectory\": null}")
            fi
          fi

          echo "VERCEL_ORG_ID=$SCOPE" >> $GITHUB_ENV
      - name: Deploy Backend to Vercel
        id: vercel-deploy
        uses: amondnet/vercel-action@v25
        continue-on-error: false
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID || secrets.VERCEL_ORG_ID || secrets.VERCEL_USER_ID }}
          vercel-project-id: ${{ env.VERCEL_BACKEND_PROJECT_ID || secrets.VERCEL_BACKEND_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: ./apps/backend
          scope: ${{ env.VERCEL_ORG_ID || secrets.VERCEL_ORG_ID || secrets.VERCEL_USER_ID }}

  notify:
    name: Deployment Notification
    needs: [deploy-backend-vercel, deploy-frontend-vercel]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment Status
        run: |
          BACKEND_STATUS="${{ needs.deploy-backend-vercel.result }}"
          FRONTEND_STATUS="${{ needs.deploy-frontend-vercel.result }}"

          if [ "$BACKEND_STATUS" == "success" ]; then
            echo "Backend deployed successfully"
          else
            echo "Backend deployment failed"
          fi

          if [ "$FRONTEND_STATUS" == "success" ]; then
            echo "Frontend deployed successfully"
          else
            echo "Frontend deployment failed"
          fi

          if [ "$BACKEND_STATUS" != "success" ] || [ "$FRONTEND_STATUS" != "success" ]; then
            exit 1
          fi
